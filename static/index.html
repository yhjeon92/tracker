<!DOCTYPE html>
<head>
    <title>Just a sample...</title>
    <link rel="stylesheet" href="./leaflet.css" />
    <script src="./leaflet.js"></script>
    <script src="./plotly-2.12.1.min.js"></script>
    <script src="./result.js"></script>
    <style>
        #map {
            /* width: 1200px; */
            /* height: 800px; */
            align-content: center;
            margin-top: 15px;
            border: 10px;
        }

        container {
            display: block;
            /* border: 1px solid #B22222; */
            border: none;
            border-radius: 1px;
            margin: auto;
            margin-top: 30px;
            margin-bottom: 30px;
        }

        h1 {
            display: block;
            text-align: center;
            color: #6a6a6a;
        }

        radio {
            margin-left: 30px;
        }
    </style>
</head>
<body>
    <h1 id='title'>Title</h1>
    <container id='mapContainer' style="width:1280px;height:960px;">
        <select name="mapType" id="mapType" onchange="changeMapType()">
            <option value="none">Choose a map type</option>
            <option value="openstreetmap" selected>OpenStreetMap</option>
            <option value="mapbox">Mapbox</option>
            <option value="google">Google</option>
            <option value="vw">VW</option>
        </select>
        <form id="fileUploadForm" enctype="multipart/form-data">
        <input id="fileProfile" type="file" name="profile" />
        <input type="button" value="submit" id="submitButton" />
        </form>
        <script>
            const submitButton = document.getElementById("submitButton");

            document.getElementById("fileProfile").onchange = () => {
                console.log(document.getElementById("fileProfile").files[0]);
            }

            const submit = () => {
                var form = document.getElementById("fileUploadForm");
                var inputFile = document.getElementById("fileProfile");

                console.log(inputFile.files.length);
                if (inputFile.files.length > 0) {
                    var formData = new FormData();
                    formData.append('file', inputFile.files[0]);
                    fetch("/upload", {
                        method: "POST",
                        body: formData
                    }).then(res => res.json())
                        .then(res => console.log(res.message))
                        .catch((error) => ("Something went wrong!", error));
                }
            };
            submitButton.onclick = submit;
        </script>
        <div id='map' style="width:1200px;height:800px;margin-left:40px;"></div>
    </container>
    <input type="button" value="Toggle detail" id="toggleDetail">
    <input type="button" value="Toggle marker" id="toggleMarker">
    <input type="button" value="Reset view" id="resetView">
    <script src="./trail.js"></script>
    <script src="./sample-geojson.js" type="text/javascript"></script>
    <container style="width:1200px;height:500px;">
        <div id="workoutPlot" style="margin-top:15px;margin-bottom:15px;"></div>
    </container>
    <input type="button" value="To timestamp" id="plotAxisToggle">
    <script>
        document.getElementById('title').innerHTML = titleString;
        const changeMapType = () => {
            var typeSelect = document.getElementById("mapType");
            var selectedValue = typeSelect.options[typeSelect.selectedIndex].value;
            switch (selectedValue) {
                case 'openstreetmap':
                    console.log(selectedValue);
                    map.removeLayer(L.tileLayer);
                    mapLayer = L.tileLayer(OSMUrlFormat, mapLayoutOptions);
                    mapLayer.redraw();
                    mapLayer.addTo(map);
                    break;
                case 'mapbox':
                    console.log(selectedValue);
                    map.removeLayer(L.tileLayer);
                    mapLayer = L.tileLayer(mapBoxUrlFormat, mapLayoutOptions);
                    mapLayer.redraw();
                    mapLayer.addTo(map);
                    break;
                case 'google':
                    console.log(selectedValue);
                    map.removeLayer(L.tileLayer);
                    mapLayer = L.tileLayer(googleMapUrlFormat, mapLayoutOptions);
                    mapLayer.redraw();
                    mapLayer.addTo(map);
                    break;
                case 'vw':
                    console.log(selectedValue);
                    map.removeLayer(L.tileLayer);
                    mapLayer = L.tileLayer(VWUrlFormat, mapLayoutOptions);
                    mapLayer.redraw();
                    mapLayer.addTo(map);
            }
        };
    </script>
    <script>
        pointCoordinates = trail['features'][0]['geometry']['coordinates'];
        showDetail = false;
        showMarker = true;
        const redrawMap = () => {
            showDetail = !showDetail;
            trail['features'][0]['properties']['underConstruction'] = showDetail;

            map.removeLayer(L.geoJSON);
            trailLayer.clearLayers();
            trailLayer = L.geoJSON(trail, {
                filter: function (feature, layer) {
                    if (feature.properties) {
                        return feature.properties.underConstruction !== undefined ? !feature.properties.underConstruction : true;
                    }
                    return false;
                },

                onEachFeature: onEachFeature,

                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 4,
                        fillColor: "#ff2a2a",
                        color: "#000",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                }
            });
            trailLayer.addTo(map);

            pointLayer.clearLayers();
            pointLayer = L.geoJSON(points, {
                onEachFeature: onEachFeature,

                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 3,
                        fillColor: "#2a2aff",
                        color: "#000",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                }
            });

            if (showDetail) {
                pointLayer.addTo(map);
            }
        }
        
        const redrawMarker = () => {
            showMarker = !showMarker;
            featureCount = trail['features'].length;
            for (let i = 1; i < featureCount; i++) {
                trail['features'][i]['properties']['underConstruction'] = !showMarker;
            }

            map.removeLayer(L.geoJSON);
            trailLayer.clearLayers();
            trailLayer = L.geoJSON(trail, {
                filter: function (feature, layer) {
                    if (feature.properties) {
                        return feature.properties.underConstruction !== undefined ? !feature.properties.underConstruction : true;
                    }
                    return false;
                },

                onEachFeature: onEachFeature,

                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 4,
                        fillColor: "#ff2a2a",
                        color: "#000",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                }
            });
            trailLayer.addTo(map);
        }
        
        const resetView = () => {
            map.setView([37.39903, 127.11152], 11);
        }
        document.getElementById('resetView').onclick = resetView;
        document.getElementById('toggleDetail').onclick = redrawMap;
        document.getElementById('toggleMarker').onclick = redrawMarker;
    </script>
    <script>
        workoutPlot = document.getElementById('workoutPlot');
        var plot_data = [
            {
                name: 'Elevation (m)',
                x: distance,
                y: elevation,
                yaxis: 'y2',
                line: {
                    color: 'rgb(225, 225, 225)',
                    width: 1
                },
                fill: 'tozeroy',
                type: 'scatter',
            },
            {
                name: 'Speed',
                x: distance,
                y: velocity
            },
        ];
        var plot_layout = {
            margin: { t: 0 },
            xaxis: {
                title: {
                    text: "Distance (km)",
                    font: {
                        family: "Courier New, monospace",
                        size: 18,
                        color: "#7f7f7f"
                    }
                }
            },
            yaxis: {
                title: {
                    text: "Speed (km/h)",
                    font: {
                        family: "Courier New, monospace",
                        size: 18,
                        color: "#7f7f7f"
                    }
                },
                rangemode: 'tozero'
            },
            yaxis2: {
                title: 'Elevation(m)',
                titlefont: { color: 'rgb(148, 103, 189)' },
                tickfont: { color: 'rgb(148, 103, 189)' },
                overlaying: 'y',
                rangemode: 'tozero',
                side: 'right'
            }
        };
        Plotly.newPlot(workoutPlot, plot_data, plot_layout);
    </script>
    <script>
        const toTimestamp = () => {
            plot_data[0]['x'] = timestamp;
            plot_data[1]['x'] = timestamp;
            plot_layout['xaxis']['title']['text'] = 'Time'
            Plotly.restyle(workoutPlot, 'x', [timestamp]);

            document.getElementById("plotAxisToggle").value = "To distance";
            document.getElementById("plotAxisToggle").onclick = toDistance;
        }
        const toDistance = () => {
            plot_data[0]['x'] = distance;
            plot_data[1]['x'] = distance;
            plot_layout['xaxis']['title']['text'] = 'Distance (km)'
            Plotly.restyle(workoutPlot, 'x', [distance]);

            document.getElementById("plotAxisToggle").value = "To timestamp";
            document.getElementById("plotAxisToggle").onclick = toTimestamp;
        }
        document.getElementById("plotAxisToggle").onclick = toTimestamp;
    </script>
</body>